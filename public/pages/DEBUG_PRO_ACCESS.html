<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Pro Access - OnCallPrep</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        h2 { color: #666; font-size: 1.2rem; margin-top: 0; }
        pre {
            background: #f8f8f8;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem 0;
        }
        button:hover { background: #0052a3; }
    </style>
</head>
<body>
    <h1>üîç Pro Access Debug Tool</h1>
    <p>Use this page to debug why pro features aren't showing up.</p>

    <div class="debug-section">
        <h2>Step 1: Check Supabase Connection</h2>
        <button onclick="checkSupabase()">Check Supabase</button>
        <pre id="supabase-status">Click button to check...</pre>
    </div>

    <div class="debug-section">
        <h2>Step 2: Check Authentication</h2>
        <button onclick="checkAuth()">Check Auth Status</button>
        <pre id="auth-status">Click button to check...</pre>
    </div>

    <div class="debug-section">
        <h2>Step 3: Check User Profile</h2>
        <button onclick="checkProfile()">Check Profile</button>
        <pre id="profile-status">Click button to check...</pre>
    </div>

    <div class="debug-section">
        <h2>Step 4: Check Pro Access</h2>
        <button onclick="checkPro()">Check Pro Access</button>
        <pre id="pro-status">Click button to check...</pre>
    </div>

    <div class="debug-section">
        <h2>Step 5: Database Query (Raw)</h2>
        <button onclick="checkDatabase()">Query Database Directly</button>
        <pre id="database-status">Click button to check...</pre>
    </div>

    <!-- Load Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/scripts/config.js"></script>
    <script src="/scripts/auth.js"></script>
    <script src="/scripts/subscription.js"></script>

    <script>
        async function checkSupabase() {
            const status = document.getElementById('supabase-status');
            try {
                if (typeof supabase === 'undefined') {
                    status.innerHTML = '<span class="error">‚ùå Supabase library not loaded</span>';
                    return;
                }
                if (!SUPABASE_CONFIG || !SUPABASE_CONFIG.url) {
                    status.innerHTML = '<span class="error">‚ùå Supabase config not found</span>';
                    return;
                }
                if (!window.supabaseClient) {
                    status.innerHTML = '<span class="error">‚ùå Supabase client not initialized</span>\nTry: initSupabase()';
                    return;
                }
                status.innerHTML = '<span class="success">‚úÖ Supabase connected</span>\n' + 
                    'URL: ' + SUPABASE_CONFIG.url + '\n' +
                    'Client initialized: ' + (window.supabaseClient ? 'Yes' : 'No');
            } catch (error) {
                status.innerHTML = '<span class="error">‚ùå Error: ' + error.message + '</span>';
            }
        }

        async function checkAuth() {
            const status = document.getElementById('auth-status');
            try {
                const supabase = window.supabaseClient;
                if (!supabase) {
                    status.innerHTML = '<span class="error">‚ùå Supabase client not found</span>';
                    return;
                }
                const { data: { user }, error } = await supabase.auth.getUser();
                if (error) {
                    status.innerHTML = '<span class="error">‚ùå Auth Error: ' + error.message + '</span>';
                    return;
                }
                if (!user) {
                    status.innerHTML = '<span class="error">‚ùå Not logged in</span>\nPlease log in first.';
                    return;
                }
                status.innerHTML = '<span class="success">‚úÖ Logged in</span>\n' +
                    'User ID: ' + user.id + '\n' +
                    'Email: ' + user.email;
            } catch (error) {
                status.innerHTML = '<span class="error">‚ùå Error: ' + error.message + '</span>';
            }
        }

        async function checkProfile() {
            const status = document.getElementById('profile-status');
            try {
                const supabase = window.supabaseClient;
                if (!supabase) {
                    status.innerHTML = '<span class="error">‚ùå Supabase client not found</span>';
                    return;
                }
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                if (authError || !user) {
                    status.innerHTML = '<span class="error">‚ùå Not authenticated</span>';
                    return;
                }
                const { data: profile, error: profileError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (profileError) {
                    status.innerHTML = '<span class="error">‚ùå Profile Error: ' + profileError.message + '</span>\n' +
                        'Code: ' + profileError.code + '\n' +
                        'Details: ' + JSON.stringify(profileError, null, 2);
                    return;
                }
                status.innerHTML = '<span class="success">‚úÖ Profile found</span>\n' +
                    JSON.stringify(profile, null, 2);
            } catch (error) {
                status.innerHTML = '<span class="error">‚ùå Error: ' + error.message + '</span>';
            }
        }

        async function checkPro() {
            const status = document.getElementById('pro-status');
            try {
                const subscription = await getUserSubscription();
                status.innerHTML = JSON.stringify(subscription, null, 2) + '\n\n' +
                    'Is Pro: ' + (subscription.isPro ? '<span class="success">‚úÖ YES</span>' : '<span class="error">‚ùå NO</span>');
            } catch (error) {
                status.innerHTML = '<span class="error">‚ùå Error: ' + error.message + '</span>';
            }
        }

        async function checkDatabase() {
            const status = document.getElementById('database-status');
            try {
                const supabase = window.supabaseClient;
                if (!supabase) {
                    status.innerHTML = '<span class="error">‚ùå Supabase client not found</span>';
                    return;
                }
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                if (authError || !user) {
                    status.innerHTML = '<span class="error">‚ùå Not authenticated</span>';
                    return;
                }
                // Direct query
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('id, email, plan, subscription_status, subscription_expires_at, role')
                    .eq('id', user.id)
                    .single();
                
                if (error) {
                    status.innerHTML = '<span class="error">‚ùå Query Error: ' + error.message + '</span>';
                    return;
                }
                status.innerHTML = '<span class="success">‚úÖ Database Query Result:</span>\n' +
                    JSON.stringify(data, null, 2) + '\n\n' +
                    'Plan check: ' + (data.plan === 'pro' ? '‚úÖ' : '‚ùå') + '\n' +
                    'Status check: ' + (data.subscription_status === 'active' ? '‚úÖ' : '‚ùå') + '\n' +
                    'Expires: ' + (data.subscription_expires_at || 'Not set');
            } catch (error) {
                status.innerHTML = '<span class="error">‚ùå Error: ' + error.message + '</span>';
            }
        }

        // Auto-check on load
        window.addEventListener('load', () => {
            if (typeof initSupabase === 'function') {
                initSupabase();
            }
        });
    </script>
</body>
</html>


